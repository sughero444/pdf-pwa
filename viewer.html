<!doctype html>
<html lang="it">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>PDF Two-Page Viewer — Drive + Animazione</title>

<style>
  html,body{
    margin:0;
    height:100%;
    background:#000;
    overflow:hidden;
  }

  .controls{
    position:fixed;
    top:12px;
    left:12px;
    z-index:60;
    display:flex;
    gap:8px;
  }

  button{
    background:#222;
    color:#fff;
    padding:8px 10px;
    border-radius:6px;
    cursor:pointer;
    border:1px solid #333;
  }

  .viewer{
    position:fixed;
    inset:0;
    display:block;
    overflow:hidden;
    background:#000;
  }

  .strip{
    height:100%;
    display:flex;
    align-items:stretch;
    box-sizing:border-box;
  }

  .slot{
    flex:0 0 50vw;
    display:flex;
    align-items:center;
    justify-content:center;
    overflow:hidden;
    height:100%;
  }

  canvas{
    display:block;
    max-height:100vh;
    width:auto;
    height:auto;
    background:#fff;
  }

  /* ─────────────── DRIVE OVERLAY ─────────────── */

  #driveOverlay {
    position: fixed;
    top: 0; left: 0; right: 0; bottom: 0;
    background: #000;
    display: none;
    flex-direction: column;
    z-index: 9999;
  }

  #driveFrame {
    flex: 1;
    width: 100%;
    border: none;
  }

  #closeDriveBtn {
    background:#222;
    color:#fff;
    padding:10px;
    border:none;
    font-size:18px;
    cursor:pointer;
    width:100%;
  }
</style>
</head>
<body>

<!-- ─────────────────────── CONTROLLI ─────────────────────── -->

<div class="controls" id="controls">
  <button id="chooseBtn">Scegli PDF</button>
  <input id="fileInput" type="file" accept="application/pdf" style="display:none">
  <button id="fullscreenBtn" disabled>Schermo intero</button>
  <button id="openDriveBtn">Apri Drive</button>
</div>

<!-- ─────────────────── VIEWER PDF ─────────────────── -->

<div class="viewer" id="viewer">
  <div class="strip" id="strip"></div>
</div>

<!-- ─────────────────── DRIVE OVERLAY ─────────────────── -->

<div id="driveOverlay">
  <button id="closeDriveBtn">Chiudi Drive</button>
  <iframe id="driveFrame" src=""></iframe>
</div>

<!-- ─────────────────── PDF.JS ─────────────────── -->

<script src="pdf.js"></script>

<script>
pdfjsLib.GlobalWorkerOptions.workerSrc = 'pdf.worker.js';

const chooseBtn = document.getElementById('chooseBtn');
const fileInput = document.getElementById('fileInput');
const fullscreenBtn = document.getElementById('fullscreenBtn');
const openDriveBtn = document.getElementById('openDriveBtn');
const controls = document.getElementById('controls');

const viewer = document.getElementById('viewer');
const strip = document.getElementById('strip');

const driveOverlay = document.getElementById("driveOverlay");
const driveFrame = document.getElementById("driveFrame");
const closeDriveBtn = document.getElementById("closeDriveBtn");

let pdfDoc = null;
let numPages = 0;
let slotWidth = window.innerWidth / 2;
let leftIndex = 1;
let totalSlots = 0;
let animating = false;
let animationHandle = null;

const TRANSITION_MS = 12000;
const QUALITY_SCALE = 1.8;

/* ───────────────────── FUNZIONI PDF ───────────────────── */

function createSlotElement(){
  const s = document.createElement('div');
  s.className = 'slot';
  return s;
}

async function renderPageCanvas(pageNum){
  const page = await pdfDoc.getPage(pageNum);
  const viewport = page.getViewport({ scale: 1 });

  const maxW = window.innerWidth / 2;
  const maxH = window.innerHeight;

  const scale = Math.min(maxW / viewport.width, maxH / viewport.height) * QUALITY_SCALE;
  const scaled = page.getViewport({ scale });

  const canvas = document.createElement('canvas');
  const ctx = canvas.getContext('2d');

  canvas.width = Math.round(scaled.width);
  canvas.height = Math.round(scaled.height);

  await page.render({ canvasContext: ctx, viewport: scaled }).promise;

  return canvas;
}

async function buildAllSlots(){
  strip.innerHTML = '';
  slotWidth = Math.round(window.innerWidth / 2);

  strip.appendChild(createSlotElement());

  for(let p=1; p<=numPages; p++){
    const slot = createSlotElement();
    const canvas = await renderPageCanvas(p);
    slot.appendChild(canvas);
    strip.appendChild(slot);
  }

  strip.appendChild(createSlotElement());
  totalSlots = numPages + 2;
}

/* ───────────────────── SCROLL / ANIMAZIONI ───────────────────── */

function animateScrollTo(targetScroll, durationMs = TRANSITION_MS){
  if(animationHandle) cancelAnimationFrame(animationHandle);

  const start = performance.now();
  const from = viewer.scrollLeft;
  const delta = targetScroll - from;

  function step(now){
    const t = Math.min(1, (now - start) / durationMs);
    viewer.scrollLeft = from + delta * t;
    if(t < 1) animationHandle = requestAnimationFrame(step);
    else animating = false;
  }

  animating = true;
  animationHandle = requestAnimationFrame(step);
}

function scrollToLeftIndexInstant(index){
  const slotIndex = Math.max(1, Math.min(index, numPages));
  viewer.scrollLeft = slotIndex * slotWidth;
  leftIndex = slotIndex;
}

function scrollNext(){
  if(animating || leftIndex >= numPages) return;
  const newIndex = leftIndex + 1;
  const target = newIndex * slotWidth;
  animateScrollTo(target, TRANSITION_MS);
  leftIndex = newIndex;
}

function scrollPrev(){
  if(animating || leftIndex <= 1) return;
  const newIndex = leftIndex - 1;
  scrollToLeftIndexInstant(newIndex);
}

/* ───────────────────── INPUT DA TASTIERA ───────────────────── */

function onKey(e){
  if(!pdfDoc) return;
  if(e.key === 'ArrowRight') scrollNext();
  else if(e.key === 'ArrowLeft') scrollPrev();
  else if(e.key === 'Escape' && document.fullscreenElement) document.exitFullscreen();
}

/* ───────────────────── EVENTI PDF ───────────────────── */

chooseBtn.addEventListener('click', ()=>{
  fileInput.value = '';
  fileInput.click();
});

fileInput.addEventListener('change', async (ev)=>{
  const f = ev.target.files && ev.target.files[0];
  if(!f) return;

  try{
    const arrayBuffer = await f.arrayBuffer();
    const loading = pdfjsLib.getDocument({ data: arrayBuffer });
    pdfDoc = await loading.promise;

    numPages = pdfDoc.numPages;
    await buildAllSlots();

    leftIndex = 1;
    viewer.scrollLeft = leftIndex * slotWidth;

    fullscreenBtn.disabled = false;
  }catch(err){
    console.error(err);
    alert("Errore nel caricamento del PDF");
  }
});

/* ───────────────────── FULLSCREEN ───────────────────── */

fullscreenBtn.addEventListener('click', async()=>{
  try{
    const docEl = document.documentElement;
    if(docEl.requestFullscreen) await docEl.requestFullscreen();
    controls.style.display = 'none';
    viewer.focus();
    window.addEventListener('keydown', onKey);
  }catch(e){}
});

document.addEventListener('fullscreenchange', ()=>{
  if(!document.fullscreenElement){
    controls.style.display = 'flex';
    window.removeEventListener('keydown', onKey);
  }
});

/* ───────────────────── RESIZE ───────────────────── */

window.addEventListener('resize', async()=>{
  if(!pdfDoc) return;
  if(animationHandle) cancelAnimationFrame(animationHandle);
  animating = false;

  slotWidth = Math.round(window.innerWidth / 2);
  await buildAllSlots();
  viewer.scrollLeft = leftIndex * slotWidth;
});

/* ───────────────────── GOOGLE DRIVE ───────────────────── */

openDriveBtn.addEventListener("click", () => {
  driveFrame.src = "https://drive.google.com/drive/u/0/my-drive";
  driveOverlay.style.display = "flex";
  controls.style.display = "none";
});

closeDriveBtn.addEventListener("click", () => {
  driveOverlay.style.display = "none";
  driveFrame.src = "";
  controls.style.display = "flex";
});
</script>

</body>
</html>
