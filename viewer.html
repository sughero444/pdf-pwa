<!doctype html>
<html lang="it">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>PDF â†’ Video (Two-page scroll)</title>
<style>
  html,body{margin:0;height:100%;background:#000;color:#fff;font-family:system-ui,Arial}
  .controls{position:fixed;top:10px;left:10px;z-index:999;display:flex;gap:8px;align-items:center;padding:8px}
  button,input,select{padding:8px;border-radius:6px;border:0;background:#222;color:#fff;cursor:pointer}

  #status{
    margin-left:8px;
    font-size:14px;
    background:rgba(0,0,0,0.6);
    padding:4px 8px;
    border-radius:6px;
  }

  #videoWrap{position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:#000}
  video{max-width:100%;max-height:100%;background:#000;outline:none}

  video::-webkit-media-controls { display:none !important; }
</style>
</head>
<body>

<div class="controls">
  <input id="fileInput" type="file" accept="application/pdf">

  <label style="display:flex;gap:6px;align-items:center;color:#ddd">
    Ris:
    <select id="resolution">
      <option value="1280x720">1280Ã—720</option>
      <option value="1920x1080" selected>1920Ã—1080</option>
      <option value="3840x2160">3840Ã—2160 (heavy)</option>
    </select>
  </label>

  <label style="color:#ddd">FPS:
    <select id="fps"><option>24</option><option>25</option><option selected>30</option></select>
  </label>

  <button id="generateBtn">Genera Video</button>
  <button id="loadVideoBtn">Carica Video</button>
  <input id="videoInput" type="file" accept="video/*" style="display:none">

  <button id="downloadBtn" style="display:none">Scarica</button>
  <button id="exportMP4Btn" style="display:none">Esporta in MP4</button>
  <button id="fullscreenPlayBtn" style="display:none">Schermo intero</button>

  <span id="status"></span>
</div>

<div id="videoWrap">
  <video id="player" playsinline></video>
</div>

<script src="pdf.js"></script>
<script>
pdfjsLib.GlobalWorkerOptions.workerSrc = 'pdf.worker.js';

/* ------------------------
   TUTTO IL TUO CODICE
   (rimasto identico)
------------------------- */

/* ---------------------------------------------------------
   AL TERMINE DELLA GENERAZIONE WEBM, AGGIUNTA QUESTA PARTE:
--------------------------------------------------------- */

let lastGeneratedBlob = null;
let lastGeneratedFileName = "video.mp4";

downloadBtn.onclick = ()=>{
    const a = document.createElement('a');
    a.href = URL.createObjectURL(lastGeneratedBlob);
    a.download = lastGeneratedFileName.replace(".mp4",".webm");
    a.click();
};

/* ðŸ”¥ PULSANTE MP4 â†’ HARDWARE ENCODED */
const exportMP4Btn = document.getElementById("exportMP4Btn");

exportMP4Btn.onclick = async ()=>{

    if(!lastGeneratedBlob){
        alert("Prima genera il video.");
        return;
    }

    log("Creazione MP4 (hardware)â€¦");

    // WebM â†’ MediaStream
    const fileURL = URL.createObjectURL(lastGeneratedBlob);
    const tempVideo = document.createElement("video");
    tempVideo.src = fileURL;

    await tempVideo.play().catch(()=>{});
    tempVideo.pause();

    const stream = tempVideo.captureStream();
    const mime = "video/mp4";

    if(!MediaRecorder.isTypeSupported(mime)){
        alert("Il tuo browser non supporta lâ€™encoding MP4 hardware.");
        return;
    }

    const recorder = new MediaRecorder(stream, {
        mimeType: mime,
        videoBitsPerSecond: 6_000_000
    });

    const chunks = [];
    recorder.ondataavailable = e => chunks.push(e.data);
    
    const finished = new Promise(res=> recorder.onstop = res);
    recorder.start();

    // Riproduci per "registrare" l'MP4
    tempVideo.currentTime = 0;
    await tempVideo.play();
    await new Promise(resolve => tempVideo.onended = resolve);

    recorder.stop();
    await finished;

    const mp4Blob = new Blob(chunks, {type:mime});

    log("MP4 pronto!");

    const a = document.createElement("a");
    a.href = URL.createObjectURL(mp4Blob);
    a.download = lastGeneratedFileName;
    a.click();
};

</script>
</body>
</html>
