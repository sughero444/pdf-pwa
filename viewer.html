<!doctype html>
<html lang="it">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>PDF TwoPage Viewer</title>
<link rel="manifest" href="manifest.json">
<style>
  html,body{margin:0;height:100%;background:#000;overflow:hidden}
  .controls{position:fixed;top:12px;left:12px;z-index:60;display:flex;gap:8px}
  button{background:#222;color:#fff;padding:8px 10px;border-radius:6px;cursor:pointer;border:1px solid #333}
  .viewer{position:fixed;inset:0;display:block;overflow:hidden;background:#000}
  .strip{height:100%;display:flex;align-items:stretch;box-sizing:border-box}
  .slot{flex:0 0 50vw;display:flex;align-items:center;justify-content:center;overflow:hidden;height:100%}
  canvas{display:block;max-height:100vh;width:auto;height:auto;background:#fff}
</style>
</head>
<body>

<div class="controls" id="controls">
  <button id="chooseBtn">Scegli PDF</button>
  <input id="fileInput" type="file" accept="application/pdf" style="display:none">
</div>

<div class="viewer" id="viewer">
  <div class="strip" id="strip"></div>
</div>

<script src="pdf.js"></script>
<script>
pdfjsLib.GlobalWorkerOptions.workerSrc = 'pdf.worker.js';

const chooseBtn = document.getElementById('chooseBtn');
const fileInput = document.getElementById('fileInput');
const viewer = document.getElementById('viewer');
const strip = document.getElementById('strip');
const controls = document.getElementById('controls');

let pdfDoc = null;
let numPages = 0;
let slotWidth = window.innerWidth / 2;
let leftIndex = 1;
let totalSlots = 0;
const TRANSITION_MS = 12000;
const QUALITY_SCALE = 1.5;
let animating = false;

function createSlot() {
  const s = document.createElement('div');
  s.className = 'slot';
  return s;
}

async function renderPage(pageNum) {
  const page = await pdfDoc.getPage(pageNum);
  const viewport = page.getViewport({ scale: 1 });
  const scale = Math.min((window.innerWidth / 2) / viewport.width, window.innerHeight / viewport.height) * QUALITY_SCALE;
  const scaled = page.getViewport({ scale });
  const canvas = document.createElement('canvas');
  const ctx = canvas.getContext('2d');
  canvas.width = scaled.width;
  canvas.height = scaled.height;
  await page.render({ canvasContext: ctx, viewport: scaled }).promise;
  return canvas;
}

async function buildSlots() {
  strip.innerHTML = '';
  slotWidth = Math.round(window.innerWidth / 2);
  strip.appendChild(createSlot()); // slot fittizio iniziale
  for (let p = 1; p <= numPages; p++) {
    const slot = createSlot();
    const canvas = await renderPage(p);
    slot.appendChild(canvas);
    strip.appendChild(slot);
  }
  strip.appendChild(createSlot());
  totalSlots = numPages + 2;
}

function animateScroll(targetScroll) {
  const from = viewer.scrollLeft;
  const delta = targetScroll - from;
  const start = performance.now();
  function step(now) {
    const t = Math.min(1, (now - start) / TRANSITION_MS);
    viewer.scrollLeft = from + delta * t;
    if (t < 1) requestAnimationFrame(step);
  }
  requestAnimationFrame(step);
}

function nextPage() {
  if (leftIndex < numPages) {
    leftIndex++;
    animateScroll(leftIndex * slotWidth);
  }
}

function prevPage() {
  if (leftIndex > 1) {
    leftIndex--;
    viewer.scrollLeft = leftIndex * slotWidth; // istantaneo
  }
}

function onKey(e) {
  if (e.key === 'ArrowRight') nextPage();
  if (e.key === 'ArrowLeft') prevPage();
  if (e.key === 'Escape') document.exitFullscreen();
}

async function openFullscreen() {
  const docEl = document.documentElement;
  if (docEl.requestFullscreen) await docEl.requestFullscreen();
  controls.style.display = 'none';
  window.addEventListener('keydown', onKey);
}

chooseBtn.addEventListener('click', () => fileInput.click());
fileInput.addEventListener('change', async (ev) => {
  const file = ev.target.files[0];
  if (!file) return;
  const buf = await file.arrayBuffer();
  const loading = pdfjsLib.getDocument({ data: buf });
  pdfDoc = await loading.promise;
  numPages = pdfDoc.numPages;
  await buildSlots();
  viewer.scrollLeft = slotWidth;
  openFullscreen();
});

window.addEventListener('resize', () => {
  if (!pdfDoc) return;
  buildSlots();
});
</script>
<script>
if ('serviceWorker' in navigator) {
  navigator.serviceWorker.register('service-worker.js')
    .then(() => console.log('Service Worker registrato'));
}
</script>
</body>
</html>
