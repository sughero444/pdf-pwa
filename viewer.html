<!doctype html>
<html lang="it">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>PDF Two-Page Viewer — Google Drive Edition</title>

<style>
  html,body{margin:0;height:100%;background:#000;overflow:hidden}
  .controls{position:fixed;top:12px;left:12px;z-index:60;display:flex;gap:8px}
  button{background:#222;color:#fff;padding:8px 10px;border-radius:6px;cursor:pointer;border:1px solid #333}
  .viewer{position:fixed;inset:0;display:block;overflow:hidden;background:#000}
  .strip{height:100%;display:flex;align-items:stretch;box-sizing:border-box}
  .slot{flex:0 0 50vw;display:flex;align-items:center;justify-content:center;overflow:hidden;height:100%}
  canvas{display:block;max-height:100vh;width:auto;height:auto;background:#fff}

  /* Popup URL */
  #urlPopup {
    position:fixed; top:0; left:0; right:0; bottom:0;
    background:rgba(0,0,0,0.8);
    display:none; align-items:center; justify-content:center;
    z-index:200;
  }
  #urlBox {
    background:#222; padding:20px; border-radius:12px;
    width:90%; max-width:420px;
    display:flex; flex-direction:column; gap:12px;
  }
  input[type=text]{padding:8px; border-radius:6px; border:1px solid #444; background:#111; color:#fff;}
</style>
</head>

<body>

<div class="controls" id="controls">
  <button id="chooseBtn">Scegli PDF</button>
  <input id="fileInput" type="file" accept="application/pdf" style="display:none">

  <button id="driveBtn">Drive</button>
  <button id="fullscreenBtn" disabled>Schermo intero</button>
</div>

<div id="urlPopup">
  <div id="urlBox">
    <div style="color:#fff;font-size:16px;">Incolla qui il link del PDF da Google Drive:</div>
    <input type="text" id="driveUrlInput" placeholder="https://drive.google.com/...">
    <button id="loadDriveBtn">Carica PDF</button>
    <button id="closePopupBtn">Annulla</button>
  </div>
</div>

<div class="viewer" id="viewer">
  <div class="strip" id="strip"></div>
</div>

<script src="pdf.js"></script>
<script>
pdfjsLib.GlobalWorkerOptions.workerSrc = 'pdf.worker.js';

const chooseBtn = document.getElementById('chooseBtn');
const fileInput = document.getElementById('fileInput');
const fullscreenBtn = document.getElementById('fullscreenBtn');
const driveBtn = document.getElementById('driveBtn');

const viewer = document.getElementById('viewer');
const strip = document.getElementById('strip');

let pdfDoc = null;
let numPages = 0;
let slotWidth = window.innerWidth / 2;
let leftIndex = 1;
let totalSlots = 0;
let animating = false;
let animationHandle = null;

const TRANSITION_MS = 12000;
const QUALITY_SCALE = 2.0;

/* Popup elementi */
const urlPopup = document.getElementById("urlPopup");
const driveUrlInput = document.getElementById("driveUrlInput");
const loadDriveBtn = document.getElementById("loadDriveBtn");
const closePopupBtn = document.getElementById("closePopupBtn");

/* FUNZIONI */
function createSlotElement() {
  const s = document.createElement('div');
  s.className = 'slot';
  return s;
}

async function renderPageCanvas(pageNum) {
  const page = await pdfDoc.getPage(pageNum);
  const viewport = page.getViewport({ scale: 1 });

  const maxW = window.innerWidth / 2;
  const maxH = window.innerHeight;
  const scale = Math.min(maxW / viewport.width, maxH / viewport.height) * QUALITY_SCALE;

  const scaled = page.getViewport({ scale });
  const canvas = document.createElement('canvas');
  const ctx = canvas.getContext('2d');
  canvas.width = Math.round(scaled.width);
  canvas.height = Math.round(scaled.height);

  await page.render({ canvasContext: ctx, viewport: scaled }).promise;
  return canvas;
}

async function buildAllSlots() {
  strip.innerHTML = '';
  slotWidth = Math.round(window.innerWidth / 2);

  strip.appendChild(createSlotElement());
  for (let p=1; p<=numPages; p++) {
    const slot = createSlotElement();
    const canvas = await renderPageCanvas(p);
    slot.appendChild(canvas);
    strip.appendChild(slot);
  }
  strip.appendChild(createSlotElement());

  totalSlots = numPages + 2;
}

function animateScrollTo(targetScroll, durationMs = TRANSITION_MS) {
  if (animationHandle) cancelAnimationFrame(animationHandle);
  const start = performance.now();
  const from = viewer.scrollLeft;
  const delta = targetScroll - from;

  function step(now) {
    const t = Math.min(1, (now - start) / durationMs);
    viewer.scrollLeft = from + delta * t;
    if (t < 1) animationHandle = requestAnimationFrame(step);
    else animating = false;
  }

  animating = true;
  animationHandle = requestAnimationFrame(step);
}

function scrollToLeftIndexInstant(index) {
  const slotIndex = Math.max(1, Math.min(index, numPages));
  viewer.scrollLeft = slotIndex * slotWidth;
  leftIndex = slotIndex;
}

function scrollNext() {
  if (animating || leftIndex >= numPages) return;
  const newIndex = leftIndex + 1;
  animateScrollTo(newIndex * slotWidth, TRANSITION_MS);
  leftIndex = newIndex;
}

function scrollPrev() {
  if (animating || leftIndex <= 1) return;
  scrollToLeftIndexInstant(leftIndex - 1);
}

/* EVENTI */

chooseBtn.addEventListener('click', ()=>{ fileInput.value=''; fileInput.click(); });

fileInput.addEventListener('change', async (ev) => {
  const f = ev.target.files?.[0];
  if (!f) return;

  try {
    const arrayBuffer = await f.arrayBuffer();
    const loading = pdfjsLib.getDocument({ data: arrayBuffer });
    pdfDoc = await loading.promise;
    numPages = pdfDoc.numPages;

    await buildAllSlots();

    leftIndex = 1;
    viewer.scrollLeft = slotWidth;
    fullscreenBtn.disabled = false;

  } catch (err) {
    console.error(err);
    alert("Errore nel caricamento PDF");
  }
});

/* Pulsante Drive → apre popup */
driveBtn.addEventListener("click", () => {
  urlPopup.style.display = "flex";
});

/* Chiudi popup */
closePopupBtn.addEventListener("click", () => {
  urlPopup.style.display = "none";
  driveUrlInput.value = "";
});

/* Carica PDF da URL */
loadDriveBtn.addEventListener("click", async () => {
  const url = driveUrlInput.value.trim();
  if (!url) return;

  urlPopup.style.display = "none";

  try {
    const res = await fetch(url);
    const buf = await res.arrayBuffer();

    const loading = pdfjsLib.getDocument({ data: buf });
    pdfDoc = await loading.promise;
    numPages = pdfDoc.numPages;

    await buildAllSlots();
    leftIndex = 1;
    viewer.scrollLeft = slotWidth;
    fullscreenBtn.disabled = false;

  } catch (err) {
    console.error(err);
    alert("Errore nel caricamento del PDF da URL");
  }
});

fullscreenBtn.addEventListener('click', async () => {
  try {
    await document.documentElement.requestFullscreen();
  } catch(e){}
  controls.style.display = 'none';
  viewer.tabIndex = -1;
  viewer.focus();

  window.addEventListener('keydown', onKey);
});

function onKey(e){
  if (!pdfDoc) return;
  if (e.key === 'ArrowRight') scrollNext();
  if (e.key === 'ArrowLeft') scrollPrev();
}

document.addEventListener('fullscreenchange', () => {
  if (!document.fullscreenElement) {
    controls.style.display = 'flex';
    window.removeEventListener('keydown', onKey);
  }
});

window.addEventListener('resize', async () => {
  if (!pdfDoc) return;
  if (animationHandle) cancelAnimationFrame(animationHandle);
  animating = false;
  slotWidth = Math.round(window.innerWidth / 2);
  await buildAllSlots();
  viewer.scrollLeft = leftIndex * slotWidth;
});
</script>

</body>
</html>
