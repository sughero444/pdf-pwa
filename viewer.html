<!doctype html>
<html lang="it">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>PDF → Video Scrolling Viewer</title>

<style>
  body {
    margin:0;
    background:#000;
    color:white;
    font-family:sans-serif;
    overflow:hidden;
  }

  .controls {
    position:fixed;
    top:10px;
    left:10px;
    z-index:50;
    display:flex;
    gap:8px;
    flex-wrap:wrap;
  }

  button, select {
    background:#222;
    color:#fff;
    border:1px solid #444;
    padding:8px 10px;
    border-radius:6px;
    cursor:pointer;
  }

  #playerWrap {
    position:fixed;
    inset:0;
    display:none;
    align-items:center;
    justify-content:center;
    background:black;
  }

  video {
    max-width:100%;
    max-height:100%;
    background:black;
  }

  #log {
    position:fixed;
    bottom:10px;
    left:10px;
    color:#aaa;
    font-size:14px;
    white-space:pre-line;
  }
</style>
</head>
<body>

<div class="controls">
  <button id="fileBtn">Scegli PDF</button>
  <input id="fileInput" type="file" accept="application/pdf" style="display:none">

  <label>
    <select id="resolution">
      <option value="720">720p</option>
      <option value="1080" selected>1080p</option>
      <option value="1440">1440p</option>
      <option value="2160">4K (2160p)</option>
    </select>
  </label>

  <button id="generateBtn">Genera Video</button>
  <button id="loadVideoBtn">Carica Video</button>

  <button id="downloadBtn" style="display:none">Scarica</button>
  <button id="fullscreenPlayBtn" style="display:none">Schermo intero</button>
</div>

<div id="playerWrap">
  <video id="player" playsinline></video>
</div>

<div id="log"></div>

<script src="pdf.js"></script>
<script>
pdfjsLib.GlobalWorkerOptions.workerSrc = "pdf.worker.js";

let pdfDoc = null;
let frames = [];
let FPS = 30;               // fissi
let SECONDS_PER_PAGE = 12;  // scorrimento
let player = null;
let stepTargetTime = null;

// LOG ----------------------------------------------------
function log(t){
  document.getElementById("log").textContent = t;
}

// FILE PICKER PDF ----------------------------------------
document.getElementById("fileBtn").onclick = () => {
  document.getElementById("fileInput").value = "";
  document.getElementById("fileInput").click();
};

document.getElementById("fileInput").onchange = async (ev) => {
  const f = ev.target.files[0];
  if (!f) return;
  const buf = await f.arrayBuffer();
  pdfDoc = await pdfjsLib.getDocument({data:buf}).promise;
  log("PDF caricato. Pagine: " + pdfDoc.numPages);
};

// GENERA VIDEO -------------------------------------------
document.getElementById("generateBtn").onclick = async () => {
  if (!pdfDoc) {
    alert("Carica prima un PDF.");
    return;
  }

  const targetHeight = parseInt(document.getElementById("resolution").value, 10);
  log("Generazione video…");

  frames = [];

  // canvas principale per cattura
  const canvas = document.createElement("canvas");
  const ctx = canvas.getContext("2d");

  for (let p = 1; p <= pdfDoc.numPages; p++) {

    const page = await pdfDoc.getPage(p);
    const viewport = page.getViewport({scale:2});

    const scale = targetHeight / viewport.height;
    const scaledViewport = page.getViewport({ scale: 2 * scale });

    canvas.width = scaledViewport.width;
    canvas.height = scaledViewport.height;

    await page.render({
      canvasContext: ctx,
      viewport: scaledViewport
    }).promise;

    let totalFrames = FPS * SECONDS_PER_PAGE;

    for (let i=0; i<totalFrames; i++) {
      // pushiamo la pagina già disegnata nel canvas
      frames.push(canvas.toDataURL());
    }
  }

  // ENCODER VIDEO
  const stream = canvas.captureStream(FPS);
  const recorder = new MediaRecorder(stream, {mimeType:"video/webm"});
  let chunks = [];

  recorder.ondataavailable = e => chunks.push(e.data);
  recorder.onstop = () => {
    const blob = new Blob(chunks, {type:"video/webm"});
    const url = URL.createObjectURL(blob);

    const downloadBtn = document.getElementById("downloadBtn");
    downloadBtn.style.display = "inline";
    downloadBtn.onclick = () => {
      const a = document.createElement("a");
      a.href = url;
      a.download = "scroll_" + targetHeight + "p.webm";
      a.click();
    };

    showVideo(url);
    log("Video generato.");
  };

  recorder.start();

  let i = 0;
  function writeFrame(){
    if (i >= frames.length) {
      recorder.stop();
      return;
    }
    let img = new Image();
    img.onload = () => {
      ctx.drawImage(img, 0, 0);
      i++;
      requestAnimationFrame(writeFrame);
    };
    img.src = frames[i];
  }
  writeFrame();
};

// MOSTRA VIDEO ------------------------------------------
function showVideo(url){
  player = document.getElementById("player");
  player.src = url;
  player.pause();
  player.currentTime = 0;

  document.getElementById("playerWrap").style.display = "flex";
  document.getElementById("fullscreenPlayBtn").style.display = "inline";

  log("Video pronto. Premi Freccia Destra per avanzare.");
}

// CARICA VIDEO ESTERNO -----------------------------------
document.getElementById("loadVideoBtn").onclick = () => {
  const input = document.createElement("input");
  input.type = "file";
  input.accept = "video/webm,video/mp4";

  input.onchange = () => {
    const file = input.files[0];
    if (!file) return;

    const url = URL.createObjectURL(file);
    showVideo(url);

    document.getElementById("downloadBtn").style.display = "none";
    stepTargetTime = null;
  };

  input.click();
};

// FULLSCREEN --------------------------------------------
document.getElementById("fullscreenPlayBtn").onclick = () => {
  const wrap = document.getElementById("playerWrap");
  if (wrap.requestFullscreen) wrap.requestFullscreen();
  player.pause();
};

// Frecce per avanzare -----------------------------------
window.addEventListener("keydown", e => {
  if (!player) return;

  if (e.key === "ArrowRight") {
    stepTargetTime = player.currentTime + SECONDS_PER_PAGE;
    if (stepTargetTime > player.duration) stepTargetTime = player.duration;
    player.play();
  }

  if (e.key === "ArrowLeft") {
    stepTargetTime = player.currentTime - SECONDS_PER_PAGE;
    if (stepTargetTime < 0) stepTargetTime = 0;
    player.play();
    const check = () => {
      if (!player.paused && player.currentTime <= stepTargetTime) {
        player.pause();
      } else requestAnimationFrame(check);
    };
    check();
  }
});

// Arresto automatico allo step --------------------------
function checkStep(){
  if (stepTargetTime !== null && player && !player.paused) {
    if (player.currentTime >= stepTargetTime) {
      player.pause();
      stepTargetTime = null;
    }
  }
  requestAnimationFrame(checkStep);
}
checkStep();

</script>
</body>
</html>
