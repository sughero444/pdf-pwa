<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>PDF TwoPage Viewer</title>
  <style>
    html, body {
      margin: 0;
      padding: 0;
      height: 100%;
      overflow: hidden;
      background: black;
    }
    #controls {
      position: fixed;
      top: 10px;
      left: 10px;
      z-index: 100;
    }
    #viewer {
      display: flex;
      height: 100%;
      width: 100%;
      overflow-x: hidden;
      scroll-behavior: auto; /* controlliamo noi l’animazione */
    }
    canvas {
      height: 100%;
      width: auto;
      display: block;
    }
  </style>
</head>
<body>

  <div id="controls">
    <input type="file" id="fileInput" accept="application/pdf">
    <button id="fullscreenBtn">Fullscreen</button>
  </div>

  <div id="viewer"></div>

  <script src="pdf.js"></script>
  <script>
    const fileInput = document.getElementById('fileInput');
    const fullscreenBtn = document.getElementById('fullscreenBtn');
    const viewer = document.getElementById('viewer');
    let pdfDoc = null;

    // -------------------------------------------------------------
    // FUNZIONE ANIMAZIONE AVANTI (12 SECONDI VELOCITÀ COSTANTE)
    // -------------------------------------------------------------
    function scrollForwardSmooth(distance) {
      const duration = 12000; // 12 secondi
      const start = viewer.scrollLeft;
      const end = start + distance;
      const startTime = performance.now();

      function animate(now) {
        const elapsed = now - startTime;
        const t = Math.min(elapsed / duration, 1); // progress 0→1 lineare
        viewer.scrollLeft = start + (end - start) * t;

        if (t < 1) {
          requestAnimationFrame(animate);
        }
      }

      requestAnimationFrame(animate);
    }

    // -------------------------------------------------------------
    // CARICAMENTO DEL PDF
    // -------------------------------------------------------------
    fileInput.addEventListener('change', async (e) => {
      const file = e.target.files[0];
      if (!file) return;

      const arrayBuffer = await file.arrayBuffer();
      pdfDoc = await pdfjsLib.getDocument({ data: arrayBuffer }).promise;
      viewer.innerHTML = '';

      for (let i = 1; i <= pdfDoc.numPages; i++) {
        const canvas = document.createElement('canvas');
        const ctx = canvas.getContext('2d');
        viewer.appendChild(canvas);

        const page = await pdfDoc.getPage(i);
        const viewport = page.getViewport({ scale: 2.5 });
        canvas.height = viewport.height;
        canvas.width = viewport.width;
        await page.render({ canvasContext: ctx, viewport }).promise;
      }

      viewer.scrollLeft = 0;
      viewer.focus();
    });

    // -------------------------------------------------------------
    // FULLSCREEN
    // -------------------------------------------------------------
    fullscreenBtn.addEventListener('click', () => {
      const elem = document.documentElement;
      elem.requestFullscreen();
      fullscreenBtn.style.display = 'none';
      fileInput.style.display = 'none';
    });

    // -------------------------------------------------------------
    // NAVIGAZIONE TASTIERA
    // -------------------------------------------------------------
    window.addEventListener('keydown', (e) => {
      if (!pdfDoc) return;

      if (e.key === 'ArrowRight') {
        scrollForwardSmooth(window.innerWidth); // animazione 12s
      }
      else if (e.key === 'ArrowLeft') {
        viewer.scrollBy({ left: -window.innerWidth }); // istantaneo
      }
      else if (e.key === 'Escape' && document.fullscreenElement) {
        document.exitFullscreen();
        fullscreenBtn.style.display = 'inline';
        fileInput.style.display = 'inline';
      }
    });

    // -------------------------------------------------------------
    // SWIPE SU ANDROID
    // -------------------------------------------------------------
    let touchStartX = 0;
    let touchEndX = 0;

    viewer.addEventListener('touchstart', (e) => {
      touchStartX = e.changedTouches[0].screenX;
    });

    viewer.addEventListener('touchend', (e) => {
      touchEndX = e.changedTouches[0].screenX;
      handleSwipe();
    });

    function handleSwipe() {
      if (!pdfDoc) return;

      const delta = touchEndX - touchStartX;

      if (Math.abs(delta) < 50) return; // evita tocchi involontari

      if (delta < 0) {
        // Swipe verso sinistra → avanti (animato)
        scrollForwardSmooth(window.innerWidth);
      } else {
        // Swipe verso destra → indietro (istantaneo)
        viewer.scrollBy({ left: -window.innerWidth });
      }
    }

  </script>
</body>
</html>

