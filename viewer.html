<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>PDF → Video Viewer</title>

<style>
    body {
        margin: 0;
        background: #000;
        color: white;
        font-family: sans-serif;
        text-align: center;
        user-select: none;
    }

    #videoElement {
        width: 100vw;
        height: 100vh;
        object-fit: contain;
        background: black;
    }

    #controls {
        padding: 10px;
        background: rgba(0,0,0,0.4);
        position: fixed;
        top: 0;
        width: 100%;
        z-index: 10;
    }

    #messageLabel {
        position: fixed;
        bottom: 20px;
        left: 50%;
        transform: translateX(-50%);
        padding: 10px 20px;
        background: rgba(0,0,0,0.6);
        color: white;
        border-radius: 8px;
        font-size: 18px;
        z-index: 20;
        display: none;
    }

    button, select {
        padding: 8px 14px;
        margin: 5px;
        font-size: 16px;
    }
</style>
</head>
<body>

<div id="controls">
    <input type="file" id="pdfInput" accept="application/pdf" />
    <select id="resolutionSelect">
        <option value="1280x720">1280×720 (HD)</option>
        <option value="1920x1080" selected>1920×1080 (Full HD)</option>
        <option value="2560x1440">2560×1440 (2K)</option>
        <option value="3840x2160">3840×2160 (4K)</option>
    </select>
    <button id="generateButton">Genera Video</button>

    <input type="file" id="videoInput" accept="video/mp4" style="margin-left:20px" />
</div>

<video id="videoElement"></video>

<div id="messageLabel"></div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.min.js"></script>

<script>
let videoElement = document.getElementById("videoElement");
let messageLabel = document.getElementById("messageLabel");

let videoBlob = null;
let videoReady = false;   // ⭐ NUOVA VARIABILE

function showMessage(msg) {
    messageLabel.innerText = msg;
    messageLabel.style.display = "block";
    setTimeout(() => {
        messageLabel.style.display = "none";
    }, 2500);
}

document.getElementById("videoInput").addEventListener("change", function (e) {
    const file = e.target.files[0];
    if (!file) return;

    const url = URL.createObjectURL(file);
    videoElement.src = url;
    videoElement.pause();

    videoBlob = null;
    videoReady = true;   // ⭐ INDICA CHE IL VIDEO È PRONTO A PARTIRE

    showMessage("Video caricato!");
});

// —————————————————————————————————————————————
// EVENTO FRECCIA DESTRA (PLAY)
// —————————————————————————————————————————————
document.addEventListener("keydown", function (e) {
    if (e.key === "ArrowRight") {
        if (videoReady) {
            videoElement.play();
        }
    }
});

// —————————————————————————————————————————————
// SCHERMO INTERO
// —————————————————————————————————————————————
videoElement.addEventListener("click", async () => {
    if (videoElement.requestFullscreen) {
        await videoElement.requestFullscreen();
    } else if (videoElement.webkitRequestFullscreen) {
        await videoElement.webkitRequestFullscreen();
    }
});

// —————————————————————————————————————————————
// GENERATORE VIDEO (VERSIONE CHE FUNZIONAVA)
// —————————————————————————————————————————————
document.getElementById("generateButton").addEventListener("click", async () => {
    const file = document.getElementById("pdfInput").files[0];
    if (!file) {
        showMessage("Seleziona un PDF prima!");
        return;
    }

    showMessage("Generazione video...");

    const resolution = document.getElementById("resolutionSelect").value;
    const [w, h] = resolution.split("x").map(Number);

    const pdf = await pdfjsLib.getDocument(URL.createObjectURL(file)).promise;

    const canvas = document.createElement("canvas");
    const ctx = canvas.getContext("2d");

    canvas.width = w;
    canvas.height = h;

    const stream = canvas.captureStream(30); // 30 FPS
    const recorder = new MediaRecorder(stream, { mimeType: "video/webm" });

    const chunks = [];
    recorder.ondataavailable = e => chunks.push(e.data);

    recorder.onstop = () => {
        const webmBlob = new Blob(chunks, { type: "video/webm" });

        videoBlob = webmBlob;
        videoReady = true;

        const url = URL.createObjectURL(webmBlob);
        videoElement.src = url;
        videoElement.pause();

        showMessage("Video generato!");
    };

    recorder.start();

    for (let i = 1; i <= pdf.numPages; i++) {
        const page = await pdf.getPage(i);
        const viewport = page.getViewport({ scale: 2 });

        const tempCanvas = document.createElement("canvas");
        tempCanvas.width = viewport.width;
        tempCanvas.height = viewport.height;
        await page.render({ canvasContext: tempCanvas.getContext("2d"), viewport }).promise;

        for (let x = 0; x < viewport.width; x++) {
            ctx.drawImage(tempCanvas, x, 0, 1, viewport.height, x - (i - 1) * viewport.width, 0, 1, h);
        }

        await new Promise(r => setTimeout(r, 12000)); // 12s per pagina
    }

    recorder.stop();
});
</script>

</body>
</html>
