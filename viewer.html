<!doctype html>
<html lang="it">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>PDF Two-Page Viewer â€” Ultra Sharp Casting</title>

<style>
  html,body{
    margin:0;
    height:100%;
    background:#000;
    overflow:hidden;
  }

  .controls{
    position:fixed;
    top:12px;
    left:12px;
    z-index:60;
    display:flex;
    gap:8px;
  }

  button{
    background:#222;
    color:#fff;
    padding:8px 10px;
    border-radius:6px;
    cursor:pointer;
    border:1px solid #333;
  }

  .viewer{
    position:fixed;
    inset:0;
    display:block;
    overflow:hidden;
    background:#000;
  }

  .strip{
    height:100%;
    display:flex;
    align-items:stretch;
    box-sizing:border-box;
  }

  .slot{
    flex:0 0 50vw;
    display:flex;
    align-items:center;
    justify-content:center;
    overflow:hidden;
    height:100%;
  }

  canvas{
    display:block;
    background:#fff;
  }
</style>
</head>

<body>

<div class="controls" id="controls">
  <button id="chooseBtn">Scegli PDF</button>
  <input id="fileInput" type="file" accept="application/pdf" style="display:none">
  <button id="fullscreenBtn" disabled>Schermo intero</button>
</div>

<div class="viewer" id="viewer">
  <div class="strip" id="strip"></div>
</div>

<script src="pdf.js"></script>

<script>
// ------------------------------------------------------
// PDF.js worker
// ------------------------------------------------------
pdfjsLib.GlobalWorkerOptions.workerSrc = 'pdf.worker.js';

// ------------------------------------------------------
// UI DOM
// ------------------------------------------------------
const chooseBtn = document.getElementById('chooseBtn');
const fileInput = document.getElementById('fileInput');
const fullscreenBtn = document.getElementById('fullscreenBtn');
const controls = document.getElementById('controls');

const viewer = document.getElementById('viewer');
const strip = document.getElementById('strip');

// ------------------------------------------------------
// Stato
// ------------------------------------------------------
let pdfDoc = null;
let numPages = 0;
let slotWidth = window.innerWidth / 2;
let leftIndex = 1;
let totalSlots = 0;

let animating = false;
let animationHandle = null;

const TRANSITION_MS = 12000;

// ------------------------------------------------------
// ðŸ”¥ QUALITÃ€ MASSIMA PER CASTING
// ------------------------------------------------------
// devicePixelRatio * 4 = altissima qualitÃ 
// limite 8x per sicurezza
const QUALITY_SCALE = Math.min(8, window.devicePixelRatio * 4);


// ------------------------------------------------------
// Utility slot
// ------------------------------------------------------
function createSlotElement(){
  const s = document.createElement('div');
  s.className = 'slot';
  return s;
}


// ------------------------------------------------------
// RENDER PDF PAGE in ULTRA-HD
// ------------------------------------------------------
async function renderPageCanvas(pageNum){
  const page = await pdfDoc.getPage(pageNum);
  const viewport = page.getViewport({ scale: 1 });

  // Dimensioni render target
  const targetWidth  = viewport.width  * QUALITY_SCALE;
  const targetHeight = viewport.height * QUALITY_SCALE;

  const ratio = viewport.width / viewport.height;

  let finalWidth = targetWidth;
  let finalHeight = finalWidth / ratio;

  if (finalHeight > targetHeight){
    finalHeight = targetHeight;
    finalWidth = finalHeight * ratio;
  }

  const scale = finalWidth / viewport.width;
  const scaled = page.getViewport({ scale });

  // Canvas Full Resolution
  const canvas = document.createElement('canvas');
  canvas.width = Math.round(scaled.width);
  canvas.height = Math.round(scaled.height);

  // IMPORTANTE: nessuno scaling CSS â†’ nitidezza massima
  canvas.style.width = scaled.width + "px";
  canvas.style.height = "auto";

  const ctx = canvas.getContext('2d', { alpha:false });

  await page.render({
    canvasContext: ctx,
    viewport: scaled
  }).promise;

  return canvas;
}


// ------------------------------------------------------
// Build strip
// ------------------------------------------------------
async function buildAllSlots(){
  strip.innerHTML = '';
  slotWidth = Math.round(window.innerWidth / 2);

  // Dummy left
  strip.appendChild(createSlotElement());

  for (let p = 1; p <= numPages; p++){
    const slot = createSlotElement();
    const canvas = await renderPageCanvas(p);
    slot.appendChild(canvas);
    strip.appendChild(slot);
  }

  // Dummy right
  strip.appendChild(createSlotElement());
  totalSlots = numPages + 2;
}


// ------------------------------------------------------
// Animazione avanti (destra)
// ------------------------------------------------------
function animateScrollTo(targetScroll, durationMs = TRANSITION_MS){
  if (animationHandle) cancelAnimationFrame(animationHandle);

  const start = performance.now();
  const from  = viewer.scrollLeft;
  const delta = targetScroll - from;

  function step(now){
    const t = Math.min(1, (now - start) / durationMs);
    viewer.scrollLeft = from + delta * t; // linea retta
    if (t < 1) animationHandle = requestAnimationFrame(step);
    else animating = false;
  }

  animating = true;
  animationHandle = requestAnimationFrame(step);
}


// ------------------------------------------------------
// Scorrimenti
// ------------------------------------------------------
function scrollToLeftIndexInstant(index){
  const i = Math.max(1, Math.min(index, numPages));
  viewer.scrollLeft = i * slotWidth;
  leftIndex = i;
}

function scrollNext(){
  if (animating || leftIndex >= numPages) return;
  const newIndex = leftIndex + 1;
  animateScrollTo(newIndex * slotWidth, TRANSITION_MS);
  leftIndex = newIndex;
}

function scrollPrev(){
  if (animating || leftIndex <= 1) return;
  scrollToLeftIndexInstant(leftIndex - 1);
}


// ------------------------------------------------------
// Tastiera
// ------------------------------------------------------
function onKey(e){
  if (!pdfDoc) return;
  if (e.key === 'ArrowRight') scrollNext();
  else if (e.key === 'ArrowLeft') scrollPrev();
  else if (e.key === 'Escape' && document.fullscreenElement)
    document.exitFullscreen();
}


// ------------------------------------------------------
// File Input
// ------------------------------------------------------
chooseBtn.addEventListener('click', () => {
  fileInput.value = '';
  fileInput.click();
});

fileInput.addEventListener('change', async ev => {
  const file = ev.target.files && ev.target.files[0];
  if (!file) return;

  try{
    const arrayBuffer = await file.arrayBuffer();
    pdfDoc = await pdfjsLib.getDocument({ data: arrayBuffer }).promise;
    numPages = pdfDoc.numPages;

    await buildAllSlots();
    leftIndex = 1;
    viewer.scrollLeft = slotWidth;

    fullscreenBtn.disabled = false;
  } catch (e){
    console.error(e);
    alert("Errore nel caricamento del PDF");
  }
});


// ------------------------------------------------------
// Fullscreen
// ------------------------------------------------------
fullscreenBtn.addEventListener('click', async () => {
  try{
    const el = document.documentElement;
    if (el.requestFullscreen) await el.requestFullscreen();
    else if (el.webkitRequestFullscreen) await el.webkitRequestFullscreen();
  }catch(e){
    console.warn("Fullscreen non disponibile", e);
    return;
  }

  controls.style.display = 'none';
  viewer.tabIndex = -1;
  viewer.focus();
  window.addEventListener('keydown', onKey);
});

document.addEventListener('fullscreenchange', () => {
  if (!document.fullscreenElement){
    controls.style.display = 'flex';
    window.removeEventListener('keydown', onKey);
  }
});


// ------------------------------------------------------
// Resize window â†’ ricostruzione completa
// ------------------------------------------------------
window.addEventListener('resize', async () => {
  if (!pdfDoc) return;

  if (animationHandle) cancelAnimationFrame(animationHandle);
  animating = false;

  slotWidth = Math.round(window.innerWidth / 2);
  await buildAllSlots();

  viewer.scrollLeft = leftIndex * slotWidth;
});
</script>

</body>
</html>
